name: Upload dataset to S3 via EC2

on:
  workflow_dispatch:  # có thể chạy thủ công
  push:
    branches: [ main ]

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Tạo file PEM từ secret
      - name: Create PEM file
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2-key.pem
          chmod 600 ec2-key.pem

      # Khai báo biến môi trường để dễ dùng
      - name: Set environment variables
        run: |
          echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> $GITHUB_ENV
          echo "S3_BUCKET=${{ secrets.S3_BUCKET }}" >> $GITHUB_ENV
          echo "EC2_USER=ec2-user" >> $GITHUB_ENV
          echo "EC2_HOST=ec2-13-239-241-158.ap-southeast-2.compute.amazonaws.com" >> $GITHUB_ENV
        # ⚠️ Thay <EC2_PUBLIC_DNS> bằng DNS thật, ví dụ:
        # ec2-13-214-101-45.ap-southeast-1.compute.amazonaws.com

      # Upload script từ repo lên EC2
      - name: Copy dataset script to EC2
        run: |
          scp -o StrictHostKeyChecking=no -i ./ec2-key.pem ./scripts/download_dataset.sh $EC2_USER@$EC2_HOST:/home/$EC2_USER/

      # SSH vào EC2, cài AWS CLI và chạy script upload lên S3
      - name: Run script on EC2 and upload to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ./ec2-key.pem $EC2_USER@$EC2_HOST << 'EOF'
            set -e  # Dừng nếu có lỗi

            # Cài đặt AWS CLI (Amazon Linux đã có sẵn, nhưng chắc chắn lại)
            sudo yum update -y
            sudo yum install -y awscli wget unzip

            # Chuyển đến thư mục home
            cd /home/$USER

            # Chạy script tải dataset
            bash download_dataset.sh

            # Giả sử script tải dữ liệu vào các thư mục ./entities, ./relations, ./prerequisites
            # Upload toàn bộ dữ liệu lên S3
            aws s3 sync ./entities s3://$S3_BUCKET/entities
            aws s3 sync ./relations s3://$S3_BUCKET/relations
            aws s3 sync ./prerequisites s3://$S3_BUCKET/prerequisites

            echo "✅ Upload completed successfully."
          EOF
